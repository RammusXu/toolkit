
What I learned in 2020.

## 2020-02-19

### Use environment from parent process in Nginx(OpenResty)
在 nginx 讀取環境變數的正確方法:

- 先在 root block export 變數
- 使用 lua `os.getenv("MY_ENV"))`
```conf
env MY_ENV;
env PATH;
http {
    server {
        location / {
            content_by_lua_block {
                ngx.say(os.getenv("MY_ENV"));
                ngx.say(os.getenv("PATH"));
            }
        }
    }
}
```

### cannot create an external load balancer with mix protocols
```bash
The Service "dnsmasq" is invalid: spec.ports: Invalid value: []core.ServicePort{core.ServicePort{Name:"dnsmasq", Protocol:"TCP", Port:53, TargetPort:intstr.IntOrString{Type:1, IntVal:0, StrVal:"dnsmasq"}, NodePort:0}, core.ServicePort{Name:"dnsmasq-udp", Protocol:"UDP", Port:53, TargetPort:intstr.IntOrString{Type:1, IntVal:0, StrVal:"dnsmasq-udp"}, NodePort:0}}: cannot create an external load balancer with mix protocols
```


## 2020-02-18
### Try Dockerfile 
https://github.com/peter-evans/docker-compose-healthcheck
```
healthcheck:
  test: ["CMD-SHELL", "pg_isready -U postgres"]
  interval: 10s
  timeout: 5s
  retries: 5
```

### Docker 更新後跳出 docker-credential-osxkeychain 想使用鑰匙圈 ci-db

https://github.com/docker/for-mac/issues/3805#issuecomment-518619953

!!! Solution
    Open `~/.docker/config.json`

    Set `"credsStore":""`

### How to use cc-by-sa license

- Plain text: https://creativecommons.org/licenses/by-sa/4.0/legalcode.txt

- Image: [![](https://i.creativecommons.org/l/by-sa/4.0/88x31.png)](http://creativecommons.org/licenses/by-sa/4.0/)
  ```
  <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-sa/4.0/88x31.png" /></a>
  ```
  ```
  [![](https://i.creativecommons.org/l/by-sa/4.0/88x31.png)](http://creativecommons.org/licenses/by-sa/4.0/)
  ```

### Print a colorful text in terminal
[ANSI - 輸出文字變色](../../snippets/bash#ansi-)
```bash
echo -e "\e[1;31mHello\e[0m World"
```

### Render a chart inside markdown with canvasjs

<script>
window.onload = function () {

  var limit = 50000;
  var y = 100;    
  var data = [];
  var dataSeries = { type: "line" };
  var dataPoints = [];
  for (var i = 0; i < limit; i += 1) {
    y += Math.round(Math.random() * 10 - 5);
    dataPoints.push({
      x: i,
      y: y
    });
  }
  dataSeries.dataPoints = dataPoints;
  data.push(dataSeries);

  //Better to construct options first and then pass it as a parameter
  var options = {
    zoomEnabled: true,
    animationEnabled: true,
    title: {
      text: "Try Zooming - Panning"
    },
    axisY: {
      includeZero: false,
      lineThickness: 1
    },
    data: data  // random data
  };

  var chart = new CanvasJS.Chart("chartContainer", options);
  chart.render();
}
</script>

<div id="chartContainer" style="height: 370px; width: 100%;"></div>
<script src="https://canvasjs.com/assets/script/canvasjs.min.js"></script>

## 2020-02-15

### Restart a kubernetes resource without down time and using same config(yaml)
Kubernetes >= 1.15 
ref: https://github.com/kubernetes/kubernetes/issues/33664#issuecomment-497242094
```bash
kubectl rollout restart deployment/my-sites --namespace=default
```

### Run commnad without(ignoring) output
https://askubuntu.com/questions/474556/hiding-output-of-a-command

```bash
command > /dev/null 2>&1
command >& /dev/null
```

Example: 
Still show errors when command failed.
```bash
$ edho hi > /dev/null
zsh: command not found: edho
```
Don't show error even when command failed.
```bash
$ edho hi >& /dev/null
```

## 2020-02-13

### 在 docker-compose 中的容器互相溝通
service name 會被綁到 DNS，可以直接使用 service name 當作 host

```yaml
version: '3'
services:
  redis:
    image: "redis:alpine"
    ports:
      - "6379:6379"
  celery:
    image: "celery:4.0.2"
    environment:
      - CELERY_BROKER_URL=redis://redis
  celery-2:
    image: "celery:4.0.2"
    environment:
      - CELERY_BROKER_URL=redis://redis
```

```bash
$ docker network ls
NETWORK ID          NAME                        DRIVER              SCOPE
01681ec52fea        celery_default              bridge              local
```

```bash
$ docker exec -it celery_celery_1 bash
user@dcd8cf4a9d04:~$ ping celery-2
PING celery-2 (192.168.0.4): 56 data bytes
64 bytes from 192.168.0.4: icmp_seq=0 ttl=64 time=0.162 ms
64 bytes from 192.168.0.4: icmp_seq=1 ttl=64 time=0.223 ms
^C--- celery-2 ping statistics ---
2 packets transmitted, 2 packets received, 0% packet loss
round-trip min/avg/max/stddev = 0.162/0.193/0.223/0.031 ms
user@dcd8cf4a9d04:~$ ping celery-3
ping: unknown host
```

### mkdocs minify html got error
mkdocs.yaml
```yaml
plugins:
  - minify:
      minify_html: true
```

!!! bug
    ```bash
        print "htmlmin option " + key + " not recognized"
                            ^
    SyntaxError: Missing parentheses in call to 'print'. Did you mean print("htmlmin option " + key + " not recognized")?
    ```

!!! solution
    ref: https://github.com/byrnereese/mkdocs-minify-plugin/issues/8

    Upgrade mkdocs-minify-plugin>= ==0.2.3==