
What I learned in 2020.

## 2020-03-04
### Install netstress on kali linux
```bash
apt-get update
apt-get install netstress
```

### GKE NodeLocal DNSCache
https://cloud.google.com/kubernetes-engine/docs/how-to/nodelocal-dns-cache 

- Base on CoreDNS

### Install dnsperf on alpine
ref: 
- https://github.com/ssro/dnsperf/blob/master/Dockerfile
- https://github.com/guessi/docker-dnsperf/blob/master/bench/k8s-dnsperf-bench.yaml
```bash
DNSPERF=dnsperf-2.3.2
apk add --update --no-cache --virtual deps wget g++ make bind-dev openssl-dev libxml2-dev libcap-dev json-c-dev krb5-dev protobuf-c-dev fstrm-dev \
  && apk add --update --no-cache bind libcrypto1.1 \
  && wget https://www.dns-oarc.net/files/dnsperf/$DNSPERF.tar.gz \
  && tar zxvf $DNSPERF.tar.gz \
  && cd $DNSPERF \
  && sh configure \
  && make \
  && strip ./src/dnsperf ./src/resperf \
  && make install
```

```bash
echo "kube-dns.kube-system.svc.cluster.local A" > records.txt
```

```bash
dnsperf -l ${MAX_TEST_SECONDS} \
        -s ${DNS_SERVER_ADDR} \
        -Q ${MAX_QPS} \
        -d records.txt

dnsperf -l 100 \
        -s 10.24.0.10 \
        -T 5 \
        -c 20 \
        -q 10000 \
        -Q 100000 \
        -d records.txt

```

## 2020-03-03
### Open Google Chrome browser in Mac terminal
```bash
open -a "Google Chrome" "http://localhost:5601"
```

## 2020-03-02
### Create a temporary pod to debug and kill itself after an hour
```yaml
apiVersion: v1
kind: Pod
metadata:
  name: busybox1
  labels:
    app: busybox1
spec:
  containers:
  # - image: busybox
  - image: alpine:3.11
    command:
      - sleep
      - "3600"
    imagePullPolicy: IfNotPresent
    name: busybox
  restartPolicy: Never
```

### DNS load testing in Alpine
```bash
apk add gcc g++ make libffi-dev openssl-dev git
git clone https://github.com/jedisct1/dnsblast.git
cd dnsblast && make
#./dnsblast [host] [times] [request per second]
./dnsblast kube-dns.kube-system 10000 1000
./dnsblast 127.0.0.1 10000 1000
```

- The command above will break kube-dns.
- There are 5 kube-dns pods, but only one is receiving request.
    - Caused by iptable and UDP.

```bash
dnsmasq I0302 08:47:01.002440       1 nanny.go:146[] dnsmasq[23]: Maximum number of concurrent DNS queries reached (max: 1500)
sidecar W0302 08:47:01.248582       1 server.go:64[] Error getting metrics from dnsmasq: read udp 127.0.0.1:37986->127.0.0.1:53: i/o timeout
```

### GKE v1.13.x uses kube-dns rather than core-dns.
ref: https://cloud.google.com/kubernetes-engine/docs/release-notes#new_features_6

GKE is using kube- rather than core-dns. No idea why they are doing this.

### Install gcc compiler in Alpine
ref: https://github.com/nange/blog/issues/3
```bash
apk add gcc g++ make libffi-dev openssl-dev
```
### echo -n
https://linux.die.net/man/1/echo
```bash
-n
do not output the trailing newline
```

## 2020-02-27
### Get GitHub user info
https://developer.github.com/v3/#authentication
```bash
curl -u "username" https://api.github.com/user
curl -H "Authorization: token $PAT" https://api.github.com/user
```

## 2020-02-26
### Use CloudFlare WARP as VPN on Mac/PC
https://community.cloudflare.com/t/tutorial-how-to-use-cloudflare-warp-on-your-mac/129919?fbclid=IwAR3OlvJrv2EW3KoH3GlDA-gURM5BgPKiaP5RDjjlgBHyYpKWbryZzbrPDGw

WARP (CloudFlare VPN) is made from Wireguard. Therefore we can generate a Wirrguard config from CloudFlare and use it on PC.

### Refresh/Clean CDN cache on Tencent Cloud
https://console.cloud.tencent.com/cdn/refresh

Just type what url you want to refresh.

### You might have to verify by doing a request from a location with a Cloudflare edge
I tested it on https://tools.pingdom.com/

- test in Tokyo
- CloudFlare/Google CDN both have edges
- GCS hosting need more DNS time: 40 ms

## 2020-02-24
### CloudFlare worker - Can't resovle/find domain
Need to manully add this record to route worker.
ref: https://community.cloudflare.com/t/a-record-name-for-worker/98841

!!! solution
    Add an A record to 192.0.2.1

### CloudFlare worker - how to handle SPA
I found there's 404 when I tried to refresh in other page like /faq.

ref: https://stackoverflow.com/questions/58432345/cloudflare-workers-spa-with-vuejs
```js
options.mapRequestToAsset = req => {
    // First let's apply the default handler, which we imported from
    // '@cloudflare/kv-asset-handler' at the top of the file. We do
    // this because the default handler already has logic to detect
    // paths that should map to HTML files, for which it appends
    // `/index.html` to the path.
    req = mapRequestToAsset(req)

    // Now we can detect if the default handler decided to map to
    // index.html in some specific directory.
    if (req.url.endsWith('/index.html')) {
      // Indeed. Let's change it to instead map to the root `/index.html`.
      // This avoids the need to do a redundant lookup that we know will
      // fail.
      return new Request(`${new URL(req.url).origin}/index.html`, req)
    } else {
      // The default handler decided this is not an HTML page. It's probably
      // an image, CSS, or JS file. Leave it as-is.
      return req
    }
  }
```

## 2020-02-21
### Multiple static IP in a load balancer
Steps:

1. Manual create ip addresses.
2. Assign ip addresses to load balancer frontend
3. Use `externalIPs` instead of `loadBalancerIP`
```yaml hl_lines="9 10 11 17"
kind: Service
apiVersion: v1
metadata:
  name: dnsmasq
spec:
  selector:
    name: dnsmasq
  type: LoadBalancer
  externalIPs:
  - a.a.a.a
  - a.a.a.b
  ports:
  - name: dnsmasq-udp
    port: 53
    protocol: UDP
    targetPort: dnsmasq-udp
  # loadBalancerIP: a.a.a.a
```

### Testing HPA high memory
ref: https://github.com/feiskyer/kubernetes-handbook/blob/master/examples/hpa-memory.yaml

```yaml
apiVersion: autoscaling/v2beta1
kind: HorizontalPodAutoscaler
metadata:
  name: nginx-hpa
spec:
  scaleTargetRef:
    apiVersion: extensions/v1beta1
    kind: Deployment
    name: dnsmasq
  minReplicas: 1
  maxReplicas: 5
  metrics:
  - type: Resource
    resource:
      name: memory
      targetAverageUtilization: 60
```

and get in a container
```bash
$ kubectl exec -it dnsmasq-5964d6fdc-2ktt8 sh 
```

generate high memory usage
```bash
$ yes | tr \\n x | head -c 100m | grep n
```

### About Kubernetes HPA(Horizontal Pod Autoscaler)
ref: https://kubernetes.io/docs/tasks/run-application/horizontal-pod-autoscale

- desiredReplicas = ceil[currentReplicas * ( currentMetricValue / desiredMetricValue )]
- [每 15 秒檢查一次](https://kubernetes.io/docs/tasks/run-application/horizontal-pod-autoscale/#how-does-the-horizontal-pod-autoscaler-work)
- [預設 downscale: 5m](https://kubernetes.io/docs/tasks/run-application/horizontal-pod-autoscale/#support-for-cooldown-delay)


## 2020-02-19

### Use environment from parent process in Nginx(OpenResty)
在 nginx 讀取環境變數的正確方法:

- 先在 root block export 變數
- 使用 lua `os.getenv("MY_ENV"))`
```conf
env MY_ENV;
env PATH;
http {
    server {
        location / {
            content_by_lua_block {
                ngx.say(os.getenv("MY_ENV"));
                ngx.say(os.getenv("PATH"));
            }
        }
    }
}
```

### cannot create an external load balancer with mix protocols
```bash
The Service "dnsmasq" is invalid: spec.ports: Invalid value: []core.ServicePort{core.ServicePort{Name:"dnsmasq", Protocol:"TCP", Port:53, TargetPort:intstr.IntOrString{Type:1, IntVal:0, StrVal:"dnsmasq"}, NodePort:0}, core.ServicePort{Name:"dnsmasq-udp", Protocol:"UDP", Port:53, TargetPort:intstr.IntOrString{Type:1, IntVal:0, StrVal:"dnsmasq-udp"}, NodePort:0}}: cannot create an external load balancer with mix protocols
```


## 2020-02-18
### Try Dockerfile 
https://github.com/peter-evans/docker-compose-healthcheck
```
healthcheck:
  test: ["CMD-SHELL", "pg_isready -U postgres"]
  interval: 10s
  timeout: 5s
  retries: 5
```

### Docker 更新後跳出 docker-credential-osxkeychain 想使用鑰匙圈 ci-db

https://github.com/docker/for-mac/issues/3805#issuecomment-518619953

!!! Solution
    Open `~/.docker/config.json`

    Set `"credsStore":""`

### How to use cc-by-sa license

- Plain text: https://creativecommons.org/licenses/by-sa/4.0/legalcode.txt

- Image: [![](https://i.creativecommons.org/l/by-sa/4.0/88x31.png)](http://creativecommons.org/licenses/by-sa/4.0/)
  ```
  <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-sa/4.0/88x31.png" /></a>
  ```
  ```
  [![](https://i.creativecommons.org/l/by-sa/4.0/88x31.png)](http://creativecommons.org/licenses/by-sa/4.0/)
  ```

### Print a colorful text in terminal
[ANSI - 輸出文字變色](../../snippets/bash#ansi-)
```bash
echo -e "\e[1;31mHello\e[0m World"
```

### Render a chart inside markdown with canvasjs

<script>
window.onload = function () {

  var limit = 50000;
  var y = 100;    
  var data = [];
  var dataSeries = { type: "line" };
  var dataPoints = [];
  for (var i = 0; i < limit; i += 1) {
    y += Math.round(Math.random() * 10 - 5);
    dataPoints.push({
      x: i,
      y: y
    });
  }
  dataSeries.dataPoints = dataPoints;
  data.push(dataSeries);

  //Better to construct options first and then pass it as a parameter
  var options = {
    zoomEnabled: true,
    animationEnabled: true,
    title: {
      text: "Try Zooming - Panning"
    },
    axisY: {
      includeZero: false,
      lineThickness: 1
    },
    data: data  // random data
  };

  var chart = new CanvasJS.Chart("chartContainer", options);
  chart.render();
}
</script>

<div id="chartContainer" style="height: 370px; width: 100%;"></div>
<script src="https://canvasjs.com/assets/script/canvasjs.min.js"></script>

## 2020-02-15

### Restart a kubernetes resource without down time and using same config(yaml)
Kubernetes >= 1.15 

ref: https://github.com/kubernetes/kubernetes/issues/33664#issuecomment-497242094

Gracefully rolling restart deployment.
```bash
kubectl rollout restart deployment/my-sites --namespace=default
```

### Run commnad without(ignoring) output
https://askubuntu.com/questions/474556/hiding-output-of-a-command

```bash
command > /dev/null 2>&1
command >& /dev/null
```

Example: 
Still show errors when command failed.
```bash
$ edho hi > /dev/null
zsh: command not found: edho
```
Don't show error even when command failed.
```bash
$ edho hi >& /dev/null
```

## 2020-02-13

### 在 docker-compose 中的容器互相溝通
service name 會被綁到 DNS，可以直接使用 service name 當作 host

```yaml
version: '3'
services:
  redis:
    image: "redis:alpine"
    ports:
      - "6379:6379"
  celery:
    image: "celery:4.0.2"
    environment:
      - CELERY_BROKER_URL=redis://redis
  celery-2:
    image: "celery:4.0.2"
    environment:
      - CELERY_BROKER_URL=redis://redis
```

```bash
$ docker network ls
NETWORK ID          NAME                        DRIVER              SCOPE
01681ec52fea        celery_default              bridge              local
```

```bash
$ docker exec -it celery_celery_1 bash
user@dcd8cf4a9d04:~$ ping celery-2
PING celery-2 (192.168.0.4): 56 data bytes
64 bytes from 192.168.0.4: icmp_seq=0 ttl=64 time=0.162 ms
64 bytes from 192.168.0.4: icmp_seq=1 ttl=64 time=0.223 ms
^C--- celery-2 ping statistics ---
2 packets transmitted, 2 packets received, 0% packet loss
round-trip min/avg/max/stddev = 0.162/0.193/0.223/0.031 ms
user@dcd8cf4a9d04:~$ ping celery-3
ping: unknown host
```

### mkdocs minify html got error
mkdocs.yaml
```yaml
plugins:
  - minify:
      minify_html: true
```

!!! bug
    ```bash
        print "htmlmin option " + key + " not recognized"
                            ^
    SyntaxError: Missing parentheses in call to 'print'. Did you mean print("htmlmin option " + key + " not recognized")?
    ```

!!! solution
    ref: https://github.com/byrnereese/mkdocs-minify-plugin/issues/8

    Upgrade mkdocs-minify-plugin>= ==0.2.3==